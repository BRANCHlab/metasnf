<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Confounders • metasnf</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Confounders">
<meta name="description" content="Linearly regress out unwanted signal from features for clustering.
">
<meta property="og:description" content="Linearly regress out unwanted signal from features for clustering.
">
<meta name="google-site-verification" content="Xzz1SIDqvPwru_mXKCXAkX2pNfOz5PO_QO02QG98tZI">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasnf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a_simple_example.html">A Simple Example</a></li>
    <li><a class="dropdown-item" href="../articles/a_complete_example.html">A Complete Example</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BRANCHlab/metasnf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Confounders</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BRANCHlab/metasnf/blob/main/vignettes/confounders.Rmd" class="external-link"><code>vignettes/confounders.Rmd</code></a></small>
      <div class="d-none name"><code>confounders.Rmd</code></div>
    </div>

    
    
<style>
div.aside { background-color:#fff2e6; }
</style>
<p>Download a copy of the vignette to follow along here: <a href="https://raw.githubusercontent.com/BRANCHlab/metasnf/main/vignettes/confounders.Rmd" class="external-link">confounders.Rmd</a></p>
<p>This vignette walks through handling confounding features and
features introducing unwanted signal using the <code>metasnf</code>
package.</p>
<p>A confounding feature is one that influences both a dependent and
independent feature, making it appear as though there is a stronger
association between the two than there mechanistically is.</p>
<p>An unwanted feature (terminology which is being defined here) is a
feature that a user explicitly does not want their subtyping solution to
be strongly associated with.</p>
<div class="section level2">
<h2 id="accounting-for-confounding-features">Accounting for confounding features<a class="anchor" aria-label="anchor" href="#accounting-for-confounding-features"></a>
</h2>
<p>Simply include the confounding feature into the cluster analysis and
bear in mind that the separation across clusters you see in any feature
is not evidence of a causal link.</p>
<p>Consider the following scenario. Children raised in wealthy homes can
afford to go to better schools, are likely to be raised in less
stressful environments, and can afford tutoring outside of school.
Consequently, they have higher standardized test scores. They are also
substantially more likely to live near a lake. If you were to cluster
children according to their standardized test scores and whether or not
they live near a lake, you may find one cluster that has kids who live
near a lake and who have high test scores and a separate cluster that
has kids who don’t live near a lake and have low test scores. Of course,
there is no causal relationship indicating that living near a lake
improves your test scores, or that your test scores causally influence
your proximity to lakes. The confounding feature is household income. By
including household income in the model, you’ll get the same clusters,
but those clusters will also separate across the “confounding”
feature.</p>
</div>
<div class="section level2">
<h2 id="unwanted-signal">Unwanted signal<a class="anchor" aria-label="anchor" href="#unwanted-signal"></a>
</h2>
<p>Consider the following scenario. You wish to find clusters of
basketball players. For simplicity, let’s say there are three basketball
positions:</p>
<ul>
<li>point guards, who have a lot of assists and very few blocks</li>
<li>centers, who have very few assists and lots of blocks</li>
<li>shooting guards, who have a moderate amount of assists and blocks
(and a lot of personal fouls)</li>
</ul>
<p>You are handed a dataset containing the assists and blocks per season
of a large number of basketball players. However, half of the basketball
players are from regular players at a community center and the other
half are from the pro.</p>
<p>What does the data look like?</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://branchlab.github.io/metasnf/">metasnf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SNFtool</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generating function for the blocks-per-season of a player</span></span>
<span><span class="va">generate_blocks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">level</span>, <span class="va">position</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The average blocks per season of all basketball players</span></span>
<span>    <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">500</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span>    <span class="co"># Effect of playing in the pro</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">level</span> <span class="op">==</span> <span class="st">"pro"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">blocks</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">2000</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Match the noisiness of the pro players</span></span>
<span>        <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">blocks</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Effect of the player's position</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"pg"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">blocks</span> <span class="op">+</span> <span class="fl">0</span> <span class="co"># Just to be explicit about it</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">blocks</span> <span class="op">+</span> <span class="fl">500</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"sg"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">blocks</span> <span class="op">&lt;-</span> <span class="va">blocks</span> <span class="op">+</span> <span class="fl">250</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">blocks</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generating function for the assists-per-season of a player</span></span>
<span><span class="va">generate_assists</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">level</span>, <span class="va">position</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The average assists per season of all basketball players</span></span>
<span>    <span class="va">assists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">1000</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="co"># Effect of playing in the pro</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">level</span> <span class="op">==</span> <span class="st">"pro"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">assists</span> <span class="op">&lt;-</span> <span class="va">assists</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">2500</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Match the noisiness of the pro players</span></span>
<span>        <span class="va">assists</span> <span class="op">&lt;-</span> <span class="va">assists</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Effect of the player's position</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"pg"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">assists</span> <span class="op">&lt;-</span> <span class="va">assists</span> <span class="op">+</span> <span class="fl">400</span> <span class="co"># Just to be explicit about it</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"c"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">assists</span> <span class="op">&lt;-</span> <span class="va">assists</span> <span class="op">+</span> <span class="fl">0</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">position</span> <span class="op">==</span> <span class="st">"sg"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">assists</span> <span class="op">&lt;-</span> <span class="va">assists</span> <span class="op">+</span> <span class="fl">200</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">assists</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># Helper function to fill in blocks and assists for a player given their</span></span>
<span><span class="co"># position and level.</span></span>
<span><span class="va">generate_player_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="st">"blocks"</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span></span>
<span>        MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu">generate_blocks</span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="st">"assists"</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span></span>
<span>        MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>        FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="fu">generate_assists</span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">x</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Generate the data</span></span>
<span><span class="va">rows</span> <span class="op">&lt;-</span> <span class="fl">300</span></span>
<span><span class="va">player_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"regular"</span>, <span class="st">"pro"</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">rows</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pg"</span>, <span class="st">"c"</span>, <span class="st">"sg"</span><span class="op">)</span>, size <span class="op">=</span> <span class="va">rows</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">generate_player_data</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">player_data</span><span class="op">$</span><span class="st">"id"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">player_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot by position</span></span>
<span><span class="va">player_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">blocks</span>, y <span class="op">=</span> <span class="va">assists</span>, shape <span class="op">=</span> <span class="va">level</span>, colour <span class="op">=</span> <span class="va">position</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Let’s say we weren’t interested in the fact that pro players aren’t
the same as community center players. We just wanted to know if
different styles of play (the ground truth being the position) exist.
What kind of clustering results do we get on this data?</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metasnf_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">player_data</span>, <span class="st">"id"</span>, <span class="st">"assists"</span>, <span class="st">"blocks"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">metasnf_data</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"continuous"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    n_solutions <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    possible_snf_schemes <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    k_values <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    alpha_values <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span><span class="co">#&gt; ℹ No clustering functions specified. Using defaults.</span></span>
<span></span>
<span><span class="va">sol_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/batch_snf.html">batch_snf</a></span><span class="op">(</span><span class="va">dl</span>, <span class="va">sc</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cluster_solution_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sol_df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># matching the subject names</span></span>
<span><span class="va">metasnf_data</span><span class="op">$</span><span class="st">"uid"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"uid_"</span>, <span class="va">metasnf_data</span><span class="op">$</span><span class="st">"id"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># merging back the original data</span></span>
<span><span class="va">metasnf_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">metasnf_data</span>, <span class="va">cluster_solution_df</span>, by <span class="op">=</span> <span class="st">"uid"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metasnf_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">blocks</span>, y <span class="op">=</span> <span class="va">assists</span>, colour <span class="op">=</span> <span class="va">s1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;"></p>
<p>In this case, the default spectral clustering has done a decent job
of separating out the groups, but with too much granularity. We have
separate clusters just for pro players and just for community center
players, which is not what we want. Other clustering algorithms can fare
even worse in this context.</p>
<p>If you have R version 4.3.0 or higher, you can use the snippet
<code>factoextra::fviz_nbclust(metasnf_data[, c("assists", "blocks")], kmeans, method = "wss")</code>
to see that the optimal number of clusters is 2.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">km</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">metasnf_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"blocks"</span>, <span class="st">"assists"</span><span class="op">)</span><span class="op">]</span>, centers <span class="op">=</span> <span class="fl">2</span>, nstart <span class="op">=</span> <span class="fl">25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">km</span><span class="op">$</span><span class="st">"cluster"</span></span>
<span><span class="co">#&gt;   [1] 1 1 2 1 1 2 1 1 1 2 2 1 1 1 1 2 1 1 2 2 1 1 2 1 1 1 2 1 2 2 1 1 2 2 2 1 1</span></span>
<span><span class="co">#&gt;  [38] 2 1 1 2 1 2 1 2 1 2 2 1 2 1 2 2 2 1 1 2 2 1 2 1 1 1 2 1 2 1 2 2 1 2 2 2 1</span></span>
<span><span class="co">#&gt;  [75] 2 1 2 1 2 1 2 2 2 1 1 2 2 1 1 2 2 2 1 2 1 1 2 2 1 2 2 2 1 2 2 2 2 2 1 1 1</span></span>
<span><span class="co">#&gt; [112] 2 1 1 1 1 2 1 1 1 2 2 1 1 1 1 2 1 1 2 2 2 1 1 1 1 1 2 1 1 1 1 1 1 2 1 2 1</span></span>
<span><span class="co">#&gt; [149] 2 2 1 2 2 1 2 1 2 1 2 2 1 2 1 1 2 1 1 1 1 2 1 2 1 1 2 2 2 1 2 2 1 2 2 2 1</span></span>
<span><span class="co">#&gt; [186] 2 1 2 1 2 1 2 2 2 1 1 1 2 1 2 2 2 1 2 2 1 1 1 1 1 2 2 2 2 1 1 2 1 2 1 1 1</span></span>
<span><span class="co">#&gt; [223] 1 1 1 1 1 1 1 1 1 2 1 1 1 1 2 2 2 1 1 2 2 2 1 2 2 2 2 2 1 2 2 2 2 1 1 2 2</span></span>
<span><span class="co">#&gt; [260] 1 1 1 1 2 1 2 1 1 2 2 1 1 2 1 1 1 2 1 1 2 2 1 2 2 1 2 1 2 2 2 2 2 1 1 2 2</span></span>
<span><span class="co">#&gt; [297] 2 2 1 1</span></span>
<span></span>
<span><span class="va">metasnf_data</span><span class="op">$</span><span class="st">"kmeans"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">km</span><span class="op">$</span><span class="st">"cluster"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">metasnf_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">blocks</span>, y <span class="op">=</span> <span class="va">assists</span>, colour <span class="op">=</span> <span class="va">kmeans</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-5-1.png" width="576" style="display: block; margin: auto;"></p>
<p>To prevent the clustering from caring about the signal introduced by
the pro/community center level differences, we’ll (linearly) regress out
the effect of being a pro player.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">player_data</span><span class="op">$</span><span class="st">"adjusted_blocks"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">blocks</span> <span class="op">~</span> <span class="va">level</span>, <span class="va">player_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">player_data</span><span class="op">$</span><span class="st">"adjusted_assists"</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/residuals.html" class="external-link">resid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">assists</span> <span class="op">~</span> <span class="va">level</span>, <span class="va">player_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot by position</span></span>
<span><span class="va">player_data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>            x <span class="op">=</span> <span class="va">adjusted_blocks</span>,</span>
<span>            y <span class="op">=</span> <span class="va">adjusted_assists</span>,</span>
<span>            shape <span class="op">=</span> <span class="va">level</span>,</span>
<span>            colour <span class="op">=</span> <span class="va">position</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-6-1.png" width="576" style="display: block; margin: auto;"></p>
<p>That’s looking much more like what we want to see. Following this
correction, you’ll have a much easier identifying the clustering
structure that exists independently of the variance you don’t care about
from pro-status.</p>
</div>
<div class="section level2">
<h2 id="procedure-using-the-metasnf-package">Procedure using the <code>metasnf</code> package<a class="anchor" aria-label="anchor" href="#procedure-using-the-metasnf-package"></a>
</h2>
<p>Note that you can only adjust out signal from categorical features,
the adjustment will be linear, it will only be applied to numeric
(continuous, discrete, ordinal) data, and that the adjustment can lead
to some major information loss (see the section below)!</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">player_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;     level position    blocks   assists id adjusted_blocks adjusted_assists</span></span>
<span><span class="co">#&gt; 1 regular        c  856.4165 1015.4749  1        74.06966       -162.28888</span></span>
<span><span class="co">#&gt; 2 regular       sg  734.9430 1205.1276  2       -47.40385         27.36383</span></span>
<span><span class="co">#&gt; 3     pro       pg 2443.7954 3913.3202  3      -286.18349        198.25452</span></span>
<span><span class="co">#&gt; 4 regular        c 1141.4151  992.0313  4       359.06833       -185.73242</span></span>
<span><span class="co">#&gt; 5 regular        c  854.0715  986.2844  5        71.72467       -191.47938</span></span>
<span><span class="co">#&gt; 6     pro        c 2863.3687 3506.7345  6       133.38977       -208.33114</span></span>
<span></span>
<span><span class="va">dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">player_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"blocks"</span>, <span class="st">"assists"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"continuous"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Correction list for just the level</span></span>
<span><span class="va">unwanted_signal_list1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">player_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"level"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"player_level"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"categorical"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Correction list for both player level and position</span></span>
<span><span class="va">unwanted_signal_list2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">player_data</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"level"</span>, <span class="st">"position"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"player_level"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"player_data"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"categorical"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">adjusted_dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/linear_adjust.html">linear_adjust</a></span><span class="op">(</span><span class="va">dl</span>, <span class="va">unwanted_signal_list1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine the data from the two data_lists the second list is being merged</span></span>
<span><span class="co"># only because it also has the position data, for plotting purposes</span></span>
<span><span class="va">merged_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">adjusted_dl</span>, <span class="va">unwanted_signal_list2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">merged_df</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">blocks</span>, y <span class="op">=</span> <span class="va">assists</span>, shape <span class="op">=</span> <span class="va">level</span>, colour <span class="op">=</span> <span class="va">position</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Correcting too many things!</span></span>
<span><span class="va">adjusted_dl2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/linear_adjust.html">linear_adjust</a></span><span class="op">(</span><span class="va">dl</span>, <span class="va">unwanted_signal_list2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">merged_df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">adjusted_dl2</span>, <span class="va">unwanted_signal_list2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">merged_df2</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">blocks</span>, y <span class="op">=</span> <span class="va">assists</span>, shape <span class="op">=</span> <span class="va">level</span>, colour <span class="op">=</span> <span class="va">position</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="confounders_files/figure-html/unnamed-chunk-7-2.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="limitations-and-important-considerations">Limitations and important considerations<a class="anchor" aria-label="anchor" href="#limitations-and-important-considerations"></a>
</h2>
<div class="section level3">
<h3 id="excessive-loss-of-signal">1. Excessive loss of signal<a class="anchor" aria-label="anchor" href="#excessive-loss-of-signal"></a>
</h3>
<p>When you remove the signal associated with a feature, you will impact
every other feature to a degree that is proportional to the correlation
between that feature and the unwanted one. Practically, any feature that
is strongly correlated with your unwanted signal feature may be better
off removed.</p>
<p>Consider two features: temperature and ice cream sales. It just so
happens that ice cream sales are purely proportional to temperature,
plus some random noise. There is no other information that one could
collect to improve their ability to predict ice cream sales.</p>
<p>If you wanted to learn about the structure of ice cream sales
<em>excluding</em> the signal introduced by temperature, the adjustment
would turn the ice cream sales data into genuine pure noise. At that
point any clusters generated would be totally meaningless and
non-reproducible.</p>
</div>
<div class="section level3">
<h3 id="lack-of-accounting-for-non-linearities">2. Lack of accounting for non-linearities<a class="anchor" aria-label="anchor" href="#lack-of-accounting-for-non-linearities"></a>
</h3>
<p>The adjustment procedure is purely linear.</p>
</div>
<div class="section level3">
<h3 id="inability-to-adjust-ordinal-discrete-or-categorical-data">3. Inability to adjust ordinal, discrete, or categorical data<a class="anchor" aria-label="anchor" href="#inability-to-adjust-ordinal-discrete-or-categorical-data"></a>
</h3>
<p>Linearly adjusting categorical/factor features is not possible.
Attempting to adjust data that has a discrete or ordinal structure will
likely not completely remove the association between the regressor
features and the features being regressed.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Prashanth S Velayudhan, Xiaoqiao Xu, Prajkta Kallurkar, Ana Patricia Balbon, Maria T Secara, Adam Taback, Denise Sabac, Nicholas Chan, Shihao Ma, Bo Wang, Daniel Felsky, Stephanie H Ameis, Brian Cox, Colin Hawco, Lauren Erdman, Anne L Wheeler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
