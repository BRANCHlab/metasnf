<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Clustering Algorithms • metasnf</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Clustering Algorithms">
<meta name="description" content="Vary clustering algorithm to expand or refine the space of generated cluster solutions.
">
<meta property="og:description" content="Vary clustering algorithm to expand or refine the space of generated cluster solutions.
">
<meta name="google-site-verification" content="Xzz1SIDqvPwru_mXKCXAkX2pNfOz5PO_QO02QG98tZI">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">metasnf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting_started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a_simple_example.html">A Simple Example</a></li>
    <li><a class="dropdown-item" href="../articles/a_complete_example.html">A Complete Example</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BRANCHlab/metasnf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Clustering Algorithms</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BRANCHlab/metasnf/blob/main/vignettes/clustering_algorithms.Rmd" class="external-link"><code>vignettes/clustering_algorithms.Rmd</code></a></small>
      <div class="d-none name"><code>clustering_algorithms.Rmd</code></div>
    </div>

    
    
<style>
div.aside { background-color:#fff2e6; }
</style>
<p>Download a copy of the vignette to follow along here: <a href="https://raw.githubusercontent.com/BRANCHlab/metasnf/main/vignettes/clustering_algorithms.Rmd" class="external-link">clustering_algorithms.Rmd</a></p>
<div class="section level2">
<h2 id="clustering-algorithms">Clustering Algorithms<a class="anchor" aria-label="anchor" href="#clustering-algorithms"></a>
</h2>
<p>SNF produces a single similarity matrix that is meant to describe how
similar all the observations are to each other across all the provided
input features. Dividing that similarity matrix into subtypes requires
can be done using clustering algorithms. Within the <code>metasnf</code>
package, clustering is done by default using the spectral clustering
algorithm (as implemented by the original SNFtool package). The code
below goes over what the default clustering looks like.</p>
<div class="section level3">
<h3 id="default-clustering">Default clustering<a class="anchor" aria-label="anchor" href="#default-clustering"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://branchlab.github.io/metasnf/">metasnf</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">subc_v</span>, <span class="st">"subcortical_volume"</span>, <span class="st">"neuroimaging"</span>, <span class="st">"continuous"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">income</span>, <span class="st">"household_income"</span>, <span class="st">"demographics"</span>, <span class="st">"continuous"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">pubertal</span>, <span class="st">"pubertal_status"</span>, <span class="st">"demographics"</span>, <span class="st">"continuous"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">anxiety</span>, <span class="st">"anxiety"</span>, <span class="st">"behaviour"</span>, <span class="st">"ordinal"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">depress</span>, <span class="st">"depressed"</span>, <span class="st">"behaviour"</span>, <span class="st">"ordinal"</span><span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"unique_id"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ 188 observations dropped due to incomplete data.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    n_solutions <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    max_k <span class="op">=</span> <span class="fl">40</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span><span class="co">#&gt; ℹ No clustering functions specified. Using defaults.</span></span></code></pre></div>
<p>The clustering functions that can be used are stored within the
<em>clustering functions list</em> (<code>clust_fns_list</code> object)
of the config, while the reference to which of those functions will be
used for a particular solution is stored in the <em>settings data
frame</em> (<code>settings_df</code> object) of the config:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Available functions</span></span>
<span><span class="va">sc</span><span class="op">$</span><span class="st">"clust_fns_list"</span></span>
<span><span class="co">#&gt; [1] spectral_eigen</span></span>
<span><span class="co">#&gt; [2] spectral_rot</span></span>
<span></span>
<span><span class="co"># Which functions will be used</span></span>
<span><span class="va">sc</span><span class="op">$</span><span class="st">"settings_df"</span><span class="op">$</span><span class="st">"clust_alg"</span></span>
<span><span class="co">#&gt; [1] 1 1 2 1 2</span></span></code></pre></div>
<p>The “1” corresponds to spectral clustering using the eigen-gap
heuristic to determine the number of clusters, while the “2” corresponds
to spectral clustering using the rotation cost heuristic to determine
the number of clusters. You can find this information by running
<code><a href="../reference/snf_config.html">?snf_config</a></code>.</p>
</div>
<div class="section level3">
<h3 id="other-built-in-clustering-options">Other built-in clustering options<a class="anchor" aria-label="anchor" href="#other-built-in-clustering-options"></a>
</h3>
<p>Currently, the available clustering algorithms are:</p>
<ul>
<li><code>spectral_eigen</code></li>
<li><code>spectral_rot</code></li>
<li><code>spectral_two</code></li>
<li><code>spectral_three</code></li>
<li><code>spectral_four</code></li>
<li><code>spectral_five</code></li>
<li><code>spectral_six</code></li>
<li><code>spectral_seven</code></li>
<li><code>spectral_eight</code></li>
</ul>
<p>The first two are the defaults, and the remaining ones specifically
use 2, 3, 4, … and so on as their number of clusters rather than
whatever is calculated by a separate heuristic function.</p>
<p>To make use of any of these alternative algorithms, you’ll need to
customize the <code>clust_fns_list</code> generated during the call to
<code><a href="../reference/snf_config.html">snf_config()</a></code>. Here’s what that looks like:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The default list:</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    n_solutions <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    use_default_clust_fns <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span></span>
<span><span class="va">sc</span><span class="op">$</span><span class="st">"clust_fns_list"</span></span>
<span><span class="co">#&gt; [1] spectral_eigen</span></span>
<span><span class="co">#&gt; [2] spectral_rot</span></span>
<span></span>
<span><span class="co"># Adding algorithms provided by the package</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    n_solutions <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    clust_fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"two_cluster_spectral"</span> <span class="op">=</span> <span class="va">spectral_two</span>,</span>
<span>        <span class="st">"five_cluster_spectral"</span> <span class="op">=</span> <span class="va">spectral_five</span></span>
<span>    <span class="op">)</span>,</span>
<span>    use_default_clust_fns <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span></span>
<span><span class="co"># Note that this one has the default algorithms as well as the newly added ones</span></span>
<span><span class="va">sc</span><span class="op">$</span><span class="st">"clust_fns_list"</span></span>
<span><span class="co">#&gt; [1] spectral_eigen</span></span>
<span><span class="co">#&gt; [2] spectral_rot</span></span>
<span><span class="co">#&gt; [3] two_cluster_spectral</span></span>
<span><span class="co">#&gt; [4] five_cluster_spectral</span></span>
<span></span>
<span><span class="co"># This list has only the newly added ones</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    n_solutions <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    clust_fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="st">"two_cluster_spectral"</span> <span class="op">=</span> <span class="va">spectral_two</span>,</span>
<span>        <span class="st">"five_cluster_spectral"</span> <span class="op">=</span> <span class="va">spectral_five</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span></span>
<span><span class="va">sc</span><span class="op">$</span><span class="st">"clust_fns_list"</span></span>
<span><span class="co">#&gt; [1] two_cluster_spectral</span></span>
<span><span class="co">#&gt; [2] five_cluster_spectral</span></span></code></pre></div>
<p>When looking at the clustering functions values in the settings part
of an SNF config, you can see that there is some random fluctuation
between 1 and 2:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc</span></span>
<span><span class="co">#&gt; Settings Data Frame:</span></span>
<span><span class="co">#&gt;                         1    2    3    4    5</span></span>
<span><span class="co">#&gt; SNF hyperparameters:</span></span>
<span><span class="co">#&gt; alpha                 0.4  0.8  0.4  0.7  0.3</span></span>
<span><span class="co">#&gt; k                      46   75   18   64   16  </span></span>
<span><span class="co">#&gt; t                      20   20   20   20   20  </span></span>
<span><span class="co">#&gt; SNF scheme:</span></span>
<span><span class="co">#&gt;                         2    3    3    1    1  </span></span>
<span><span class="co">#&gt; Clustering functions:</span></span>
<span><span class="co">#&gt;                         2    2    2    1    1  </span></span>
<span><span class="co">#&gt; Distance functions:</span></span>
<span><span class="co">#&gt; CNT                     1    1    1    1    1  </span></span>
<span><span class="co">#&gt; DSC                     1    1    1    1    1  </span></span>
<span><span class="co">#&gt; ORD                     1    1    1    1    1  </span></span>
<span><span class="co">#&gt; CAT                     1    1    1    1    1  </span></span>
<span><span class="co">#&gt; MIX                     1    1    1    1    1  </span></span>
<span><span class="co">#&gt; Component dropout:</span></span>
<span><span class="co">#&gt; subcortical_volume      ✔    ✔    ✔    ✔    ✔  </span></span>
<span><span class="co">#&gt; household_income        ✔    ✔    ✔    ✔    ✔  </span></span>
<span><span class="co">#&gt; pubertal_status         ✔    ✔    ✔    ✔    ✔  </span></span>
<span><span class="co">#&gt; anxiety                 ✔    ✔    ✔    ✔    ✖  </span></span>
<span><span class="co">#&gt; depressed               ✔    ✔    ✔    ✔    ✔  </span></span>
<span><span class="co">#&gt; Distance Functions List:</span></span>
<span><span class="co">#&gt; Continuous (1):</span></span>
<span><span class="co">#&gt; [1] euclidean_distance</span></span>
<span><span class="co">#&gt; Discrete (1):</span></span>
<span><span class="co">#&gt; [1] euclidean_distance</span></span>
<span><span class="co">#&gt; Ordinal (1):</span></span>
<span><span class="co">#&gt; [1] euclidean_distance</span></span>
<span><span class="co">#&gt; Categorical (1):</span></span>
<span><span class="co">#&gt; [1] gower_distance</span></span>
<span><span class="co">#&gt; Mixed (1):</span></span>
<span><span class="co">#&gt; [1] gower_distance</span></span>
<span><span class="co">#&gt; Clustering Functions List:</span></span>
<span><span class="co">#&gt; [1] two_cluster_spectral</span></span>
<span><span class="co">#&gt; [2] five_cluster_spectral</span></span>
<span><span class="co">#&gt; Weights Matrix:</span></span>
<span><span class="co">#&gt; Weights defined for 5 cluster solutions.</span></span>
<span><span class="co">#&gt; $ smri_vol_scs_cbwmatterlh 1, 1, 1, 1, 1 </span></span>
<span><span class="co">#&gt; $ smri_vol_scs_ltventriclelh 1, 1, 1, 1, 1 </span></span>
<span><span class="co">#&gt; $ smri_vol_scs_inflatventlh 1, 1, 1, 1, 1 </span></span>
<span><span class="co">#&gt; $ smri_vol_scs_crbwmatterlh 1, 1, 1, 1, 1 </span></span>
<span><span class="co">#&gt; $ smri_vol_scs_crbcortexlh 1, 1, 1, 1, 1 </span></span>
<span><span class="co">#&gt; …and 29 more features.</span></span></code></pre></div>
<p>The settings segment contains pointers to which clustering function
to use, while the clustering functions list stores the actual
functions.</p>
<p>When you are satisfied with the clustering functions you’ve
specified, you can try them out with a typical call to
<code><a href="../reference/batch_snf.html">batch_snf()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sol_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/batch_snf.html">batch_snf</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    sc <span class="op">=</span> <span class="va">sc</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="structure-of-a-clustering-algorithm-function">Structure of a clustering algorithm function<a class="anchor" aria-label="anchor" href="#structure-of-a-clustering-algorithm-function"></a>
</h3>
<p>Any clustering algorithm can be used as long as you can write a
function for it with the following format:</p>
<ol style="list-style-type: decimal">
<li>Takes a single N*N similarity_matrix as its only input</li>
<li>Returns a named list:
<ul>
<li>The first item (named “solution”) is a single N-dimensional vector
of numbers corresponding to the observations in the similarity
matrix</li>
<li>The second item (named “nclust”) is a single integer indicating the
number of clusters that the algorithm is supposed to have generated</li>
</ul>
</li>
</ol>
<p>Note that the number of clusters parameter fed into
<code><a href="https://rdrr.io/pkg/SNFtool/man/spectralClustering.html" class="external-link">SNFtool::spectralClustering</a></code> doesn’t always return a
solution containing that many clusters. For example, an affinity matrix
where every observation is identical to all other observations could not
yield more than a 1 cluster solution, regardless of how many clusters
were requested.</p>
<p>Also note that the function should <em>not</em> take number of
clusters as an argument - if you want to explore the same clustering
algorithm with a varying number of clusters, you’ll need to provide a
separate function for each number of clusters you’re interested in.</p>
<p>The source code for the two default functions are shown below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Default clustering algorithm #1</span></span>
<span><span class="va">spectral_eigen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">similarity_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">estimated_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_nclust_given_graph.html">estimate_nclust_given_graph</a></span><span class="op">(</span></span>
<span>        W <span class="op">=</span> <span class="va">similarity_matrix</span>,</span>
<span>        NUMC <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">nclust_estimate</span> <span class="op">&lt;-</span> <span class="va">estimated_n</span><span class="op">$</span><span class="va">`Eigen-gap best`</span></span>
<span>    <span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu">SNFtool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SNFtool/man/spectralClustering.html" class="external-link">spectralClustering</a></span><span class="op">(</span></span>
<span>        <span class="va">similarity_matrix</span>,</span>
<span>        <span class="va">nclust_estimate</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">solution</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Default clustering algorithm #2</span></span>
<span><span class="va">spectral_rot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">similarity_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">estimated_n</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estimate_nclust_given_graph.html">estimate_nclust_given_graph</a></span><span class="op">(</span></span>
<span>        W <span class="op">=</span> <span class="va">similarity_matrix</span>,</span>
<span>        NUMC <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">nclust_estimate</span> <span class="op">&lt;-</span> <span class="va">estimated_n</span><span class="op">$</span><span class="va">`Rotation cost best`</span></span>
<span>    <span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu">SNFtool</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SNFtool/man/spectralClustering.html" class="external-link">spectralClustering</a></span><span class="op">(</span></span>
<span>        <span class="va">similarity_matrix</span>,</span>
<span>        <span class="va">nclust_estimate</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">solution</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="non-automated-clustering">Non-automated clustering<a class="anchor" aria-label="anchor" href="#non-automated-clustering"></a>
</h3>
<p>You can also extract the similarity matrices for each computed row of
the settings data frame and perform the clustering more “manually”. This
is particularly useful for clustering procedures where the transition
from a similarity matrix to the final solution requires human
intervention (e.g., judgement for clustering hyperparameters).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sol_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/batch_snf.html">batch_snf</a></span><span class="op">(</span></span>
<span>    <span class="va">dl</span>,</span>
<span>    <span class="va">sc</span>,</span>
<span>    return_sim_mats <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Similarity matrices are in the list below:</span></span>
<span><span class="va">similarity_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_mats_list.html">sim_mats_list</a></span><span class="op">(</span><span class="va">sol_df</span><span class="op">)</span></span>
<span></span>
<span><span class="va">first_similarity_matrix</span> <span class="op">&lt;-</span> <span class="va">similarity_matrices</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Your manual clustering goes here...</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-of-non-automated-clustering-dbscan">Example of non-automated clustering: DBSCAN<a class="anchor" aria-label="anchor" href="#example-of-non-automated-clustering-dbscan"></a>
</h3>
<p>Let’s say we wanted to cluster our similarity matrices with DBSCAN
rather than with spectral clustering. Start by taking a look at the
documentation for running the DBSCAN function from the dbscan R package
<a href="https://cran.r-project.org/package=dbscan" class="external-link">https://cran.r-project.org/package=dbscan</a>:</p>
<p>DBSCAN is about as challenging as custom clustering can get, as the
suggested process for specifying the number of clusters is recommended
to involve human intervention and the function itself operates on
dissimilarity (distance) matrices rather than similarity matrices.</p>
<p>Below is a slightly adjusted form of their <code>dbscan</code>
example. You can work through this on your own.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/dbscan" class="external-link">dbscan</a></span><span class="op">)</span></span>
<span><span class="co">## Example 1: use dbscan on the iris data set</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span><span class="va">iris</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">iris</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">iris_dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="va">iris</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Find suitable DBSCAN parameters:</span></span>
<span><span class="co">## 1. We use minPts = dim + 1 = 5 for iris. A larger value can also be used.</span></span>
<span><span class="co">## 2. We inspect the k-NN distance plot for k = minPts - 1 = 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/kNNdist.html" class="external-link">kNNdistplot</a></span><span class="op">(</span><span class="va">iris</span>, minPts <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Noise seems to start around a 4-NN distance of .7</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">.7</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html" class="external-link">dbscan</a></span><span class="op">(</span><span class="va">iris_dist</span>, eps <span class="op">=</span> <span class="fl">0.7</span>, minPts <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The 1 is added to ensure that those with no cluster (cluster 0) are still</span></span>
<span><span class="co"># plotted.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/pairs.html" class="external-link">pairs</a></span><span class="op">(</span><span class="va">iris</span>, col <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">cluster</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>After some poking around, you will often see people mentioning that
DBSCAN just isn’t meant to be automated. You need to look at your data
to have a good idea of what values to use for the hyperparameters
<code>eps</code> and <code>minPts</code>. When you need to get involved
manually, that’s the perfect time to manage the many similarity matrices
you’ve created with <code>batch_snf</code> through meta clustering.
Generate a wide range of similarity matrices and apply meta clustering
to find a few representative similarity matrices. One way to do this
would be based on how the spectral-clustering derived solutions end up
clustering together (see <a href="https://branchlab.github.io/metasnf/articles/a_complete_example.html#examining-meta-clusters">example</a>).
Then take the corresponding affinity matrices and go through the dbscan
clustering process manually.</p>
<p>Based on <code><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html" class="external-link">?dbscan</a></code>, it looks like the function can accept
precomputed distance matrices (instead of
<code>precomputed_nn_object</code>s) as long as they actually are
<code>dist</code> objects (which can be done using the
<code><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist()</a></code> function). There are many formulas to convert
between similarity matrices and distance matrices which have their own
pros and cons. Here, we’ll use a common approach of
<code>distance = max(similarity) - similarity</code>. Whichever matrix
values had the maximum similarity will now have a distance of 0, and
whichever matrix values had the lowest amount of similarity will have
distance values that are the closest to the former maximum similarity
value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/dbscan" class="external-link">dbscan</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dbscan'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     as.dendrogram</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_list.html">data_list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">expression_df</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"genes_1_and_2_exp"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"gene_expression"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"continuous"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">methylation_df</span>,</span>
<span>        name <span class="op">=</span> <span class="st">"genes_1_and_2_meth"</span>,</span>
<span>        domain <span class="op">=</span> <span class="st">"gene_methylation"</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"continuous"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    uid <span class="op">=</span> <span class="st">"patient_id"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/snf_config.html">snf_config</a></span><span class="op">(</span>dl <span class="op">=</span> <span class="va">dl</span>, n_solutions <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; ℹ No distance functions specified. Using defaults.</span></span>
<span><span class="co">#&gt; ℹ No clustering functions specified. Using defaults.</span></span>
<span></span>
<span><span class="va">sol_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/batch_snf.html">batch_snf</a></span><span class="op">(</span></span>
<span>    dl <span class="op">=</span> <span class="va">dl</span>,</span>
<span>    sc <span class="op">=</span> <span class="va">sc</span>,</span>
<span>    return_sim_mats <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">similarity_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_mats_list.html">sim_mats_list</a></span><span class="op">(</span><span class="va">sol_df</span><span class="op">)</span></span>
<span></span>
<span><span class="va">representative_sm</span> <span class="op">&lt;-</span> <span class="va">similarity_matrices</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="va">distance_matrix1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">as.dist</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">representative_sm</span><span class="op">)</span> <span class="op">-</span> <span class="va">representative_sm</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/kNNdist.html" class="external-link">kNNdistplot</a></span><span class="op">(</span></span>
<span>    <span class="va">distance_matrix1</span>,</span>
<span>    minPts <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## Maybe there?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h<span class="op">=</span><span class="fl">0.4872</span>, col <span class="op">=</span> <span class="st">"red"</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="clustering_algorithms_files/figure-html/unnamed-chunk-11-1.png" width="480"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">dbscan_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html" class="external-link">dbscan</a></span><span class="op">(</span><span class="va">distance_matrix1</span>, eps <span class="op">=</span> <span class="fl">0.4872</span>, minPts <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="st">"cluster"</span></span>
<span></span>
<span><span class="va">spectral_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">sol_df</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">dbscan_vs_spectral</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    dbscan <span class="op">=</span> <span class="va">dbscan_results</span>,</span>
<span>    spectral <span class="op">=</span> <span class="va">spectral_results</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dbscan_vs_spectral</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dbscan</span>, y <span class="op">=</span> <span class="va">spectral</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">0.1</span>, width <span class="op">=</span> <span class="fl">0.1</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="clustering_algorithms_files/figure-html/unnamed-chunk-11-2.png" width="480"></p>
<p>There’s one bold lie in the code chunk above, which is how easy it
was to find that magic hyperparameter combination of
<code>minPts = 10</code> and <code>eps = 0.487</code> parameter value of
0.4872. It wasn’t based off of the visual inspection of the kNNdistplot,
but rather through a lot of trial and error.</p>
<p>Something along the lines of:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.485</span>, <span class="fl">0.488</span>, by <span class="op">=</span> <span class="fl">0.0001</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dbscan/man/dbscan.html" class="external-link">dbscan</a></span><span class="op">(</span><span class="va">distance_matrix1</span>, eps <span class="op">=</span> <span class="va">i</span>, minPts <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="st">"cluster"</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In this specific instance, those hyperparameters are incredibly
sensitive - a slight change will get very different results. That is
likely due to the shape of the actual data being clustered. Your mileage
may vary.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Prashanth S Velayudhan, Xiaoqiao Xu, Prajkta Kallurkar, Ana Patricia Balbon, Maria T Secara, Adam Taback, Denise Sabac, Nicholas Chan, Shihao Ma, Bo Wang, Daniel Felsky, Stephanie H Ameis, Brian Cox, Colin Hawco, Lauren Erdman, Anne L Wheeler.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
