---
title: "Visualizations"
output:
    rmarkdown::html_vignette:
        toc: true
vignette: >
  %\VignetteIndexEntry{Visualizations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This vignette walks through this package's available plotting functions.

## Data set-up

Mock data setup is below.
This example currently makes use of the mock "Data1" and "Data2" objects that are made available by loading the SNFtool package.

```{r message = FALSE, results = 'hide'}
library(SNFtool)
library(metasnf)

# Load in data from SNFtool
data(Data1)
data(Data2)

# Set the possible values
gender <- c("female", "male")
diagnosis <- c("definite asthma", "possible asthma", "no asthma")
atopic_asthma <- c("Yes", "No")

# C1: mostly F, mostly "definite asthma", mostly "Yes" to atopic asthma
c1_genders <- sample(gender, 100, replace = TRUE, prob = c(3, 1))
c1_diagnosis <- sample(diagnosis, 100, replace = TRUE, prob = c(3, 2, 1))
c1_asthma <- sample(atopic_asthma, 100, replace = TRUE, prob = c(3, 1))
c1_ages <- sample(c(12:18), 100, replace = TRUE, prob = c(1:7))

c2_genders <- sample(gender, 100, replace = TRUE, prob = c(1, 3))
c2_diagnosis <- sample(diagnosis, 100, replace = TRUE, prob = c(1, 2, 3))
c2_asthma <- sample(atopic_asthma, 100, replace = TRUE, prob = c(1, 3))
c2_ages <- sample(c(18:30), 100, replace = TRUE,)

genders <- c(c1_genders, c2_genders)
diagnoses <- c(c1_diagnosis, c2_diagnosis)
asthmas <- c(c1_asthma, c2_asthma)
ages <- c(c1_ages, c2_ages)

# Assign unique patient identifiers to each patient
set.seed(42)
random_ids <- sample(100:999)[1:200]

Data1$"patient_id" <- random_ids
Data2$"patient_id" <- random_ids

# Generate data_list
data_list <- generate_data_list(
    list(Data1, "genes_1_and_2_exp", "gene_expression", "continuous"),
    list(Data2, "genes_1_and_2_meth", "gene_methylation", "continuous"),
    uid = "patient_id"
)

# Generate settings_matrix
settings_matrix <- generate_settings_matrix(
    data_list,
    nrow = 5,
    max_k = 40,
    seed = 42
)

# Run SNF and clustering
batch_snf_results <- batch_snf(
    data_list,
    settings_matrix,
    return_similarity_matrices = TRUE
)

solutions_matrix <- batch_snf_results$"solutions_matrix"
similarity_matrices <- batch_snf_results$"similarity_matrices"

# The first (and only) similarity matrix:
similarity_matrix <- similarity_matrices[[1]]

# The first (and only) cluster solution:
cluster_solutions <- get_cluster_solutions(solutions_matrix)

head(cluster_solutions)
```

Because this data is so perfect, our solution space is just the same cluster solution repeated 5 times.
The chunk below artificially varies the results to be a little more realistic:

```{r}

# 10% chance of flipping a patient's assigned cluster
noise_two_clusters <- function(two_cluster_solution) {
    noisy_solution <- two_cluster_solution |> lapply(
        function(x) {
            if (runif(1) > 0.80) {
                if (x == 1) {
                    return(2)
                } else {
                    return(1)
                }
            } else {
                return(x)
            }
        }
    ) |>
        unlist()
    return(noisy_solution)
}

for (i in seq_len(ncol(cluster_solutions) - 1)) {
    current_col <- i + 1
    cluster_solutions[, current_col] <- cluster_solutions[, current_col] |>
        noise_two_clusters()
}

head(cluster_solutions)

# Scrambling the solutions matrix
solutions_matrix[1, cluster_solutions$"subjectkey"] <- cluster_solutions$"1"
solutions_matrix[2, cluster_solutions$"subjectkey"] <- cluster_solutions$"2"
solutions_matrix[3, cluster_solutions$"subjectkey"] <- cluster_solutions$"3"
solutions_matrix[4, cluster_solutions$"subjectkey"] <- cluster_solutions$"4"
solutions_matrix[5, cluster_solutions$"subjectkey"] <- cluster_solutions$"5"

```

## Manhattan plots

Manhattan plots can be used to visualize

```{r}
# have a column for sampleID. Make sure cluster column is also in df
df_blood = data.frame(
    sampleID = seq(1:200),
    cluster = cluster_solutions$"1",
    Asthma_Diagnosis = diagnoses,
    Atopic_Asthma = asthmas
)

head(df_blood)

outcomes <- c('Asthma_Diagnosis','Atopic_Asthma')

# because both outcomes are categorical, we use chi-squared test. Assume the input data has 200 samples
output <- clusterToOutcomeCorr(
    df_blood,
    outcomes = outcomes,
    method = "chi-squared",
    datatype = "blood",
    size = 200
)

output

```

```{r fig.width = 7, fig.height = 5.5}

gender_df <- data.frame(
    patient_id = random_ids,
    gender = genders
)
diagnosis_df <- data.frame(
    patient_id = random_ids,
    diagnosis = diagnoses
)
age_df <- data.frame(
    patient_id = random_ids,
    age = ages
)

target_list <- generate_target_list(
    list(gender_df, "gender", "categorical"),
    list(diagnosis_df, "diagnosis", "categorical"),
    list(age_df, "age", "numeric"),
    uid = "patient_id"
)

extended_solutions_matrix <- extend_solutions(solutions_matrix, target_list)

target_pvals <- p_val_select(extended_solutions_matrix)

manhattan_plot(target_pvals)
```

The red dotted line represent p-value of 0.05 cutoff. The black dotted line represent the 0.05 cutoff divided by the number of data types which act as a multiple comparison correction.

